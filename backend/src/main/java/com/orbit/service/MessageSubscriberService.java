package com.orbit.service;import lombok.RequiredArgsConstructor;import lombok.extern.slf4j.Slf4j;import org.springframework.data.redis.connection.Message; // âœ… Redis ë©”ì‹œì§€import org.springframework.messaging.simp.SimpMessagingTemplate;import org.springframework.stereotype.Service;import com.fasterxml.jackson.databind.ObjectMapper;import com.orbit.dto.MessageRequestDto;@Slf4j@Service@RequiredArgsConstructorpublic class MessageSubscriberService implements org.springframework.data.redis.connection.MessageListener {    private final SimpMessagingTemplate messagingTemplate; // âœ… WebSocketì„ í†µí•´ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” ì—­í•     private final ObjectMapper objectMapper;    /**     *  Redis ë©”ì‹œì§€ ìˆ˜ì‹      *  - Redisì—ì„œ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ëŠ” ì—­í• .     *  - redisMessage : Redis Publiserê°€ ë°œí–‰í•œ ë©”ì‹œì§€     *  - ì´ ì—­í• ì„ ìˆ˜í–‰í•œ í›„, êµ¬ë… ì¤‘ì¸ WebSocket í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ë©´ ëœë‹¤.     *    ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ê³  WebSocketì„ í†µí•´ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë³´ëƒ…ë‹ˆë‹¤.     */    @Override    public void onMessage(Message redisMessage, byte[] pattern) { // âœ… RedisMessageëŠ” ë³€ìˆ˜ë¡œ ì‚¬ìš©        try {            // 1. Redis ë©”ì‹œì§€ ìˆ˜ì‹             String jsonMessage = new String(redisMessage.getBody()); // Redis Publiserê°€ ë°œí–‰í•œ ë©”ì‹œì§€ getBody()ë¡œ ê°€ì ¸ì™€ì„œ Stringìœ¼ë¡œ ë³€í™˜            log.info("ğŸ”¹ Redis Subscriber ì—ì„œ ìˆ˜ì‹ í•œ ê²½ë¡œ : {}, ë©”ì‹œì§€ ë‚´ìš©: {}", new String(pattern), jsonMessage);            // 2. ì „ë‹¬ë°›ì€ ë©”ì‹œì§€ ë‚´ìš©ì„ MessageRequestDtoë¡œ ë³€í™˜            MessageRequestDto messageDto = objectMapper.readValue(jsonMessage, MessageRequestDto.class);            log.info("âœ… WebSocketìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡: /topic/chat/{}", messageDto.getReceiverId());            // 3. Redisì—ì„œ ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ì „ë‹¬ë°›ê³  ì´ë¥¼ WebSocketì„ í†µí•´ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬            messagingTemplate.convertAndSend("/topic/chat/" + messageDto.getReceiverId(), objectMapper.writeValueAsString(messageDto));            // 4. ë°œì‹ ìì—ê²Œë„ ë™ì¼í•œ ë©”ì‹œì§€ ì „ì†¡            messagingTemplate.convertAndSend("/topic/chat/" + messageDto.getSenderId(), objectMapper.writeValueAsString(messageDto));        } catch (Exception e) {            log.error("âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);        }    }}